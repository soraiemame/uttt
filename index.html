<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div id="content">
        <table cellpadding="0px" cellspacing="0px" border="0px">
            <tbody>
                <tr>
                    <td><input readonly="readonly" class="up left" id="00"></td>
                    <td><input readonly="readonly" class="up" id="01"></td>
                    <td><input readonly="readonly" class="up right" id="02"></td>
                    <td><input readonly="readonly" class="up left" id="03"></td>
                    <td><input readonly="readonly" class="up" id="04"></td>
                    <td><input readonly="readonly" class="up right" id="05"></td>
                    <td><input readonly="readonly" class="up left" id="06"></td>
                    <td><input readonly="readonly" class="up" id="07"></td>
                    <td><input readonly="readonly" class="up right" id="08"></td>
                </tr>
                <tr>
                    <td><input readonly="readonly" class="left" id="10"></td>
                    <td><input readonly="readonly" class="" id="11"></td>
                    <td><input readonly="readonly" class="right" id="12"></td>
                    <td><input readonly="readonly" class="left" id="13"></td>
                    <td><input readonly="readonly" class="" id="14"></td>
                    <td><input readonly="readonly" class="right" id="15"></td>
                    <td><input readonly="readonly" class="left" id="16"></td>
                    <td><input readonly="readonly" class="" id="17"></td>
                    <td><input readonly="readonly" class="right" id="18"></td>
                </tr>
                <tr>
                    <td><input readonly="readonly" class="down left" id="20"></td>
                    <td><input readonly="readonly" class="down" id="21"></td>
                    <td><input readonly="readonly" class="down right" id="22"></td>
                    <td><input readonly="readonly" class="down left" id="23"></td>
                    <td><input readonly="readonly" class="down" id="24"></td>
                    <td><input readonly="readonly" class="down right" id="25"></td>
                    <td><input readonly="readonly" class="down left" id="26"></td>
                    <td><input readonly="readonly" class="down" id="27"></td>
                    <td><input readonly="readonly" class="down right" id="28"></td>
                </tr>
                <tr>
                    <td><input readonly="readonly" class="up left" id="30"></td>
                    <td><input readonly="readonly" class="up" id="31"></td>
                    <td><input readonly="readonly" class="up right" id="32"></td>
                    <td><input readonly="readonly" class="up left" id="33"></td>
                    <td><input readonly="readonly" class="up" id="34"></td>
                    <td><input readonly="readonly" class="up right" id="35"></td>
                    <td><input readonly="readonly" class="up left" id="36"></td>
                    <td><input readonly="readonly" class="up" id="37"></td>
                    <td><input readonly="readonly" class="up right" id="38"></td>
                </tr>
                <tr>
                    <td><input readonly="readonly" class="left" id="40"></td>
                    <td><input readonly="readonly" class="" id="41"></td>
                    <td><input readonly="readonly" class="right" id="42"></td>
                    <td><input readonly="readonly" class="left" id="43"></td>
                    <td><input readonly="readonly" class="" id="44"></td>
                    <td><input readonly="readonly" class="right" id="45"></td>
                    <td><input readonly="readonly" class="left" id="46"></td>
                    <td><input readonly="readonly" class="" id="47"></td>
                    <td><input readonly="readonly" class="right" id="48"></td>
                </tr>
                <tr>
                    <td><input readonly="readonly" class="down left" id="50"></td>
                    <td><input readonly="readonly" class="down" id="51"></td>
                    <td><input readonly="readonly" class="down right" id="52"></td>
                    <td><input readonly="readonly" class="down left" id="53"></td>
                    <td><input readonly="readonly" class="down" id="54"></td>
                    <td><input readonly="readonly" class="down right" id="55"></td>
                    <td><input readonly="readonly" class="down left" id="56"></td>
                    <td><input readonly="readonly" class="down" id="57"></td>
                    <td><input readonly="readonly" class="down right" id="58"></td>
                </tr>
                <tr>
                    <td><input readonly="readonly" class="up left" id="60"></td>
                    <td><input readonly="readonly" class="up" id="61"></td>
                    <td><input readonly="readonly" class="up right" id="62"></td>
                    <td><input readonly="readonly" class="up left" id="63"></td>
                    <td><input readonly="readonly" class="up" id="64"></td>
                    <td><input readonly="readonly" class="up right" id="65"></td>
                    <td><input readonly="readonly" class="up left" id="66"></td>
                    <td><input readonly="readonly" class="up" id="67"></td>
                    <td><input readonly="readonly" class="up right" id="68"></td>
                </tr>
                <tr>
                    <td><input readonly="readonly" class="left" id="70"></td>
                    <td><input readonly="readonly" class="" id="71"></td>
                    <td><input readonly="readonly" class="right" id="72"></td>
                    <td><input readonly="readonly" class="left" id="73"></td>
                    <td><input readonly="readonly" class="" id="74"></td>
                    <td><input readonly="readonly" class="right" id="75"></td>
                    <td><input readonly="readonly" class="left" id="76"></td>
                    <td><input readonly="readonly" class="" id="77"></td>
                    <td><input readonly="readonly" class="right" id="78"></td>
                </tr>
                <tr>
                    <td><input readonly="readonly" class="down left" id="80"></td>
                    <td><input readonly="readonly" class="down" id="81"></td>
                    <td><input readonly="readonly" class="down right" id="82"></td>
                    <td><input readonly="readonly" class="down left" id="83"></td>
                    <td><input readonly="readonly" class="down" id="84"></td>
                    <td><input readonly="readonly" class="down right" id="85"></td>
                    <td><input readonly="readonly" class="down left" id="86"></td>
                    <td><input readonly="readonly" class="down" id="87"></td>
                    <td><input readonly="readonly" class="down right" id="88"></td>
                </tr>
            </tbody>
        </table>
        <p id="game-info">
            Now: 1p(O)
        </p>
    </div>
    <script>
        const cells = document.querySelectorAll("input");
        let game_info = document.querySelector("#game-info");
        let px = -1,py = -1;
        let board = [];
        const lines = [
            [0,1,2],
            [3,4,5],
            [6,7,8],
            [0,3,6],
            [1,4,7],
            [2,5,8],
            [0,4,8],
            [2,5,7]
        ];
        for(let i = 0;i < 9;i++)
            board.push([-1,-1,-1,-1,-1,-1,-1,-1,-1]);
        let turn = 0;
        function bidx(x,y) {
            return [
                Math.floor(x / 3) * 3 + Math.floor(y / 3),
                x % 3 * 3 + y % 3
            ];
        }
        function eval_mini_board(sx,sy) {
            sx = Math.floor(sx / 3) * 3;
            sy = Math.floor(sy / 3) * 3;
            for(let t = 0;t < 2;t++){
                for(let line of lines) {
                    let flag = true;
                    for(let i = 0;i < 3;i++){
                        let dx = Math.floor(line[i] / 3);
                        let dy = line[i] % 3;
                        flag &= board[sx + dx][sy + dy] === t;
                    }
                    if(flag)return t;
                }
            }
            return -1;
        }
        function eval_big_board() {
            for(let t = 0;t < 2;t++){
                for(let line of lines) {
                    let flag = true;
                    for(let i = 0;i < 3;i++){
                        let dx = Math.floor(line[i] / 3);
                        let dy = line[i] % 3;
                        let mini = eval_mini_board(dx * 3,dy * 3);
                        flag &= mini === t;
                    }
                    if(flag)return t;
                }
            }
            return -1;
        }
        function next_board_idx() {
            if(px === -1)return [0,1,2,3,4,5,6,7,8];
            let b = bidx(px,py)[1];
            let x = Math.floor(b / 3);
            let y = b % 3;
            if(eval_mini_board(x * 3,y * 3) !== -1){
                let res = [];
                for(let i = 0;i < 3;i++){
                    for(let j = 0;j < 3;j++){
                        if(eval_mini_board(i * 3,j * 3) === -1)res.push(i * 3 + j);
                    }
                }
                return res;
            }
            else return [b];
        }
        function is_valid(x,y) {
            if(x < 0 || x >= 9 || y < 0 || y >= 9)return false;
            if(board[x][y] !== -1)return false;
            let valid = next_board_idx();
            let tar = bidx(x,y)[0];
            // console.log(valid,tar);
            if(valid.some(c => c == tar))return true;
            else return false;
        }
        function render_mini_board(sx,sy) {
            sx = Math.floor(sx / 3) * 3;
            sy = Math.floor(sy / 3) * 3;
            for(let t = 0;t < 2;t++){
                for(let line of lines) {
                    let flag = true;
                    for(let i = 0;i < 3;i++){
                        let dx = Math.floor(line[i] / 3);
                        let dy = line[i] % 3;
                        flag &= board[sx + dx][sy + dy] === t;
                    }
                    if(flag){
                        for(let i = 0;i < 3;i++){
                            let dx = Math.floor(line[i] / 3);
                            let dy = line[i] % 3;
                            let x = sx + dx;
                            let y = sy + dy;
                            cells[x * 9 + y].style.color = "red";
                        }
                        return;
                    }
                }
            }
        }
        function render() {
            // finished to red
            for(let i = 0;i < 3;i++){
                for(let j = 0;j < 3;j++){
                    render_mini_board(i * 3,j * 3);
                }
            }
        }
        function act(x,y) {
            if(!is_valid(x,y)){
                alert("That is invalid!");
                return;
            }
            // console.log(x,y);
            board[x][y] = turn;
            cells[x * 9 + y].value = turn === 0 ? "O" : "X";
            // console.log(board);
            turn = 1 - turn;
            px = x;
            py = y;
            game_info.innerText = `Now: ${1 + turn}p, prev: (${px},${py})`;

            let big = eval_big_board();
            render();
            if(big !== -1){
                alert(`player ${big + 1} wins!!`);
            }
        }
        for(let i = 0;i < 9;i++){
            for(let j = 0;j < 9;j++){
                cells[i * 9 + j].addEventListener("click",() => {
                    act(i,j);
                });
            }
        }
    </script>
    <style>
        table,#game-info {
            display: flex;
            justify-content: center;
        }
        input {
            height: 40px;
            width: 40px;
            margin: 0;
            border: 1px solid black;
            font-size: larger;
            text-align: center;
            cursor: default;
        }
        button {
            padding: 10px;
            font-size: large;
        }
        table {
            margin: 50px;
        }

        .up { border-top: 3px solid black; }
        .down { border-bottom: 3px solid black; }
        .left { border-left: 3px solid black;}
        .right { border-right: 3px solid black; }
    </style>
</body>

</html>